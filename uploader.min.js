//By Tychio[code@tychio.net]
window.HTML5=window.HTML5||{},window.HTML5.Uploader=function(a,b){"use strict";return function(){function a(a){if("number"==typeof a)l.max_size=a;else if("string"==typeof a)l.input_id=a;else if("object"==typeof a)for(var c in a)l[c]!==b&&(l[c]=a[c]);return m}function c(){return k(l.has_progress)&&l.has_progress(-1),k(l.has_preview)&&l.has_preview(),l.is_multiple&&document.getElementById(l.input_id).setAttribute("multiple","multiple"),document.getElementById(l.input_id).onchange=function(){if(!this.value)return m;if(k(l.has_preview)&&window.FileReader!==b){var a=[],c=this.files;l.has_preview();for(var d=0;d<c.length;d++)a[d]=new FileReader,a[d].readAsDataURL(c[d]),a[d].index=d,a[d].onload=function(a){l.has_preview(a.target,this.index)}}},m}function d(a,c,d){if(window.FormData===b)return e("Sorry, your browser don't support this function."),m;var g=document.getElementById(l.input_id).files;return f(g,0,a,c,d),m}function e(a,c){var d=document.querySelector(".alert");return a===b?(d.style.display="none",d.innerHTML="",document.getElementById(l.input_id).value=""):(c?(d.classList.add("alert-warning"),d.classList.remove("alert-success")):(d.classList.remove("alert-warning"),d.classList.add("alert-success")),d.innerHTML=a,d.style.display="block"),m}function f(a,c,d,e,i){if(!(c>=a.length)){var j=new FormData;if(j.append(l.images_name,a[c]),i!==b)for(var k in i)j.append(k,i[k]);h(a[c])?("function"==typeof e&&(e={callback:e}),e.loadend=function(){l.has_progress(101,c),f(a,c+1,d,e,i)},g(c,d,j,e)):f(a,c+1,d,e,i)}}function g(a,b,c,d){l.has_progress&&l.has_progress(0);var f=new XMLHttpRequest;f.upload.addEventListener("progress",function(b){if(b.lengthComputable){var c=b.loaded,d=b.total,f=Math.round(100*c/d);l.has_progress(f,a)}else e(l.error_compute,!0)},!1);for(var g in d)"callback"!==g&&f.upload.addEventListener(g,d[g],!1);f.open("POST",b),f.send(c),f.onreadystatechange=function(){if(4==f.readyState&&200==f.status)try{d.callback(JSON.parse(f.responseText))}catch(a){d.callback(f.responseText)}}}function h(a){return l.accept_type.test(a.type)?l.max_size<a.size?(e(l.error_size,!0),!1):(e(l.loading),!0):(e(l.error_type,!0),!1)}function i(a){function b(a,c){var d=a.parentElement;return d.className===c?d:"body"===d.tagName?!1:b(d,c)}var c=document.getElementById("html5-uploader-progress"),d=b(c,"progress");0>a||"number"!=typeof a?(c.style.width=0,d.style.display="none"):(c.style.width=a+"%",d.style.display="block")}function j(){}function k(a){return a&&"function"==typeof a}var l={max_size:2097152,accept_type:/image\/\w+/,images_name:"upload",error_type:"File Type is images file only!",error_size:"File Size too large!",error_compute:"Unable to compute",loading:"waiting for upload is complete...",input_id:"html5-uploader",is_multiple:!1,has_preview:j,has_progress:i},m={set:a,init:c,upload:d,tip:e};return m}}(window);